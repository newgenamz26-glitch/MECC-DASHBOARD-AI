<!-- Global Notification is always present for login feedback -->
<app-notification></app-notification>

@if (stateSvc.isResponderLoginFlow()) {
  <!-- Responder Login Screen -->
  <app-responder-login></app-responder-login>
} @else if (stateSvc.loggedInResponder()) {
  <!-- Responder Dashboard Screen -->
  <app-responder-dashboard></app-responder-dashboard>
} @else if (stateSvc.isLoggedIn()) {
  <!-- Main Application Interface -->

  <div class="sticky top-0 z-50">
    <!-- GPS Error Banner -->
    @if (stateSvc.gpsStatus() === 'ERROR' && stateSvc.gpsErrorMessage(); as errorMsg) {
      <div class="bg-red-500 text-white text-xs font-bold text-center p-2 shadow-md">
        <div class="max-w-md mx-auto flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
          <span>{{ errorMsg }}</span>
        </div>
      </div>
    }

    <!-- Simulation Mode Banner -->
    @if (stateSvc.isSimulationMode()) {
        <div class="bg-amber-400 text-black text-[10px] font-black text-center py-1.5 uppercase tracking-widest">
            Mode Simulasi Aktif
        </div>
    }

    <!-- Header -->
    <nav class="bg-sky-900 text-white p-5 shadow-md flex justify-between items-center rounded-b-[30px]">
        <div>
            <h1 class="font-bold text-lg leading-tight">MECC AMAL <span class="text-[10px] bg-sky-700 px-2 py-0.5 rounded-full ml-1">v{{ appVersion }}</span></h1>
            @if(stateSvc.loggedInResponder(); as responder) {
              <p class="text-[10px] text-sky-300 font-semibold">{{ responder.name }} ({{ responder.role }})</p>
            } @else {
              <p class="text-[10px] text-sky-300 uppercase tracking-widest font-bold">Respon Pintar Cloud</p>
            }
        </div>
        <div class="flex items-center gap-2">
            <!-- GPS Status -->
            <div class="flex items-center gap-1.5 bg-white/10 px-2 py-1.5 rounded-xl border border-white/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                     class="transition-colors flex-shrink-0"
                     [class.text-sky-400]="isGpsConnected()"
                     [class.text-red-500]="!isGpsConnected()"
                     [class.animate-pulse]="stateSvc.gpsStatus() === 'REQUESTING'">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>
                </svg>
                <div>
                  <p class="text-[9px] font-black uppercase tracking-wider" [class.text-white]="isGpsConnected()" [class.text-red-400]="!isGpsConnected()">
                    {{ gpsStatusMessage() }}
                  </p>
                  @if(isGpsConnected() && currentLocationDisplay()) {
                    <p class="text-[8px] font-mono text-white/70 -mt-0.5">{{ currentLocationDisplay() }}</p>
                  }
                </div>
            </div>
            <!-- Server Status -->
            <div class="flex items-center gap-1.5 bg-white/10 px-2 py-1.5 rounded-xl border border-white/20">
                @if (stateSvc.isSimulationMode()) {
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-amber-400 flex-shrink-0">
                      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline>
                  </svg>
                  <div>
                    <p class="text-[9px] font-black uppercase tracking-wider text-white">SIMULASI</p>
                    <p class="text-[8px] font-mono text-white/70 -mt-0.5">Mode Latihan</p>
                  </div>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0" [class.text-sky-400]="stateSvc.isCloudConnected()" [class.text-red-500]="!stateSvc.isCloudConnected()">
                    <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/>
                  </svg>
                  <div>
                    <p class="text-[9px] font-black uppercase tracking-wider" [class.text-white]="stateSvc.isCloudConnected()" [class.text-red-400]="!stateSvc.isCloudConnected()">
                      {{ stateSvc.isCloudConnected() ? 'CLOUD OK' : 'RALAT' }}
                    </p>
                    <p class="text-[8px] font-mono text-white/70 -mt-0.5">{{ stateSvc.isCloudConnected() ? 'Sambungan Aktif' : 'Semak Tetapan' }}</p>
                  </div>
                }
            </div>
            <button (click)="confirmLogout()" class="text-sky-300 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10 active:scale-90">
               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </button>
        </div>
    </nav>
  </div>


  <!-- Main Content -->
  <main class="max-w-md mx-auto p-4 space-y-5">
      <div [hidden]="activeTab() !== 'dashboard'"><app-dashboard></app-dashboard></div>
      <div [hidden]="activeTab() !== 'program'"><app-program-selector></app-program-selector></div>
      <div [hidden]="activeTab() !== 'report'"><app-report-generator></app-report-generator></div>
      <div [hidden]="activeTab() !== 'settings'"><app-settings></app-settings></div>
  </main>

  <!-- Bottom Navigation -->
  <div class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-xl border-t border-sky-50 flex justify-around p-5 z-50 rounded-t-[32px] shadow-[0_-10px_25px_-5px_rgba(0,0,0,0.05)]">
      <button (click)="navigate('dashboard')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-400 transition-all duration-300" [class.text-sky-600]="activeTab() === 'dashboard'" [class.-translate-y-1]="activeTab() === 'dashboard'">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M3 9h18"/></svg>
          <span class="text-[9px] font-black uppercase tracking-widest">Dashboard</span>
      </button>
      <button (click)="navigate('program')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-400 transition-all duration-300" [class.text-sky-600]="activeTab() === 'program'" [class.-translate-y-1]="activeTab() === 'program'">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          <span class="text-[9px] font-black uppercase tracking-widest">Program</span>
      </button>
      <button (click)="showAiAssistant()" title="Bantuan AI: Cari Fasiliti Terdekat" class="nav-btn flex flex-col items-center gap-1.5 text-slate-400 transition-all duration-300 hover:text-teal-500 active:-translate-y-1">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
          <span class="text-[9px] font-black uppercase tracking-widest">Bantuan AI</span>
      </button>
      <button (click)="navigate('report')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-400 transition-all duration-300" [class.text-sky-600]="activeTab() === 'report'" [class.-translate-y-1]="activeTab() === 'report'">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
          <span class="text-[9px] font-black uppercase tracking-widest">Laporan</span>
      </button>
      <button (click)="navigate('settings')" class="nav-btn flex flex-col items-center gap-1.5 text-slate-400 transition-all duration-300" [class.text-sky-600]="activeTab() === 'settings'" [class.-translate-y-1]="activeTab() === 'settings'">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span class="text-[9px] font-black uppercase tracking-widest">Tetapan</span>
      </button>
  </div>
} @else {
  <!-- Login Screen -->
  <app-login></app-login>
}

<!-- Feedback Modal -->
@if (isFeedbackModalVisible()) {
  <app-feedback-form (close)="hideFeedbackModal()"></app-feedback-form>
}

<!-- Logout Confirmation Modal -->
@if (stateSvc.isLogoutConfirmVisible()) {
  <div class="fixed inset-0 bg-black/60 z-[9998] flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl p-6 shadow-xl w-full max-w-sm text-center animate-fade-in-up">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-500 mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        <h3 class="font-bold text-lg text-slate-800">Sahkan Log Keluar</h3>
        <p class="text-sm text-slate-500 mt-2">Adakah anda pasti mahu menamatkan sesi semasa dan kembali ke skrin utama?</p>
        <div class="grid grid-cols-2 gap-3 mt-6">
            <button (click)="cancelLogout()" class="bg-slate-100 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-200 transition-colors">
                Batal
            </button>
            <button (click)="logout()" class="bg-red-500 text-white font-bold py-3 rounded-xl hover:bg-red-600 transition-colors">
                Ya, Log Keluar
            </button>
        </div>
    </div>
  </div>
}

<!-- AI Assistant Modal -->
@if (isAiAssistantVisible()) {
  <app-ai-assistant (close)="hideAiAssistant()"></app-ai-assistant>
}

<!-- Interactive User Guide -->
<app-user-guide></app-user-guide>