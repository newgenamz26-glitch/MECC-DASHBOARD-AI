@if (stateSvc.isUserGuideVisible()) {
  <div class="fixed inset-0 bg-black/70 z-[9998] flex items-center justify-center p-4 animate-fade-in-up">
    <!-- Visible Interactive Guide -->
    <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl flex flex-col overflow-hidden" (click)="$event.stopPropagation()">
      
      <!-- Progress Bar -->
      <div class="w-full bg-sky-100 h-2">
        <div class="bg-sky-500 h-2 rounded-r-full" [style.width.%]="progressPercentage()" style="transition: width 0.3s ease-out;"></div>
      </div>

      <!-- Header -->
      <div class="p-5 flex justify-between items-start gap-4">
        <div class="flex items-center gap-4">
          <div class="text-3xl bg-slate-100 p-3 rounded-xl">{{ currentStep().icon }}</div>
          <div>
            <p class="text-xs font-bold text-slate-400">Langkah {{ currentStepIndex() + 1 }} / {{ guideSteps.length }}</p>
            <h3 class="font-bold text-slate-800 text-lg leading-tight">{{ currentStep().title }}</h3>
          </div>
        </div>
        <button (click)="closeGuide()" class="p-2 bg-slate-100 rounded-full text-slate-600 hover:bg-slate-200 transition-colors flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      
      <!-- Content -->
      <div class="px-5 pb-5 text-sm" [innerHTML]="currentStep().content">
      </div>

      <!-- Footer Actions -->
      <div class="p-4 bg-slate-50/70 border-t border-slate-200 flex-shrink-0 space-y-3 rounded-b-3xl">
        <div class="flex justify-between items-center gap-3">
          <button 
            (click)="previousStep()" 
            class="text-sm font-bold text-slate-500 hover:text-slate-800 transition-colors px-4 py-2"
            [class.invisible]="currentStepIndex() === 0"
          >
            Kembali
          </button>

          <button 
            (click)="nextStep()" 
            class="text-sm font-bold bg-sky-600 text-white px-6 py-2.5 rounded-xl hover:bg-sky-700 transition-colors"
          >
            @if (currentStepIndex() === guideSteps.length - 1) {
              <span>Selesai</span>
            } @else {
              <span>Seterusnya</span>
            }
          </button>
        </div>
         <div class="grid grid-cols-2 gap-3 pt-3 border-t border-slate-200">
            <button (click)="downloadAsPdf()" [disabled]="isGeneratingPdf()" class="w-full flex items-center justify-center gap-2 bg-white text-sky-700 font-bold text-xs py-2.5 rounded-lg border border-sky-200 hover:bg-sky-100 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed">
              @if(isGeneratingPdf()) {
                <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                <span>Menjana...</span>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span>Muat Turun PDF</span>
              }
            </button>
             <button (click)="shareGuide()" class="w-full flex items-center justify-center gap-2 bg-white text-sky-700 font-bold text-xs py-2.5 rounded-lg border border-sky-200 hover:bg-sky-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                <span>Kongsi Panduan</span>
            </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden container for PDF generation -->
  <div class="absolute -left-[9999px] top-0 w-[800px] bg-white p-8 font-sans text-black" id="user-guide-pdf-content">
    <div class="text-center mb-12">
      <h1 class="text-4xl font-black text-sky-800">Panduan Pengguna Sistem MECC AMAL</h1>
      <p class="text-xl text-slate-600 mt-2">Versi 2.6</p>
    </div>
    <div class="space-y-12">
      @for (step of guideSteps; track step.title; let i = $index) {
        <div class="break-inside-avoid">
          <div class="flex items-center gap-6 mb-5 pb-4 border-b border-slate-200">
            <div class="text-5xl bg-slate-100 p-4 rounded-3xl">{{ step.icon }}</div>
            <div>
              <p class="text-base font-bold text-slate-500">Langkah {{ i + 1 }}</p>
              <h2 class="text-3xl font-bold text-slate-800">{{ step.title }}</h2>
            </div>
          </div>
          <div class="prose prose-lg max-w-none text-slate-700" [innerHTML]="step.content"></div>
        </div>
      }
    </div>
    <p class="mt-16 text-center text-sm text-slate-500">Dokumen ini dijana secara automatik oleh Sistem MECC AMAL pada {{ getFormattedTimestamp() }}</p>
  </div>
}
<style>
  .prose img {
    border-radius: 0.5rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }
  .prose ul {
    padding-left: 1.5rem;
  }
  .prose li {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
</style>
