<div class="space-y-6">
  <!-- Program Selection Section -->
  <div class="space-y-4">
    <div class="flex justify-between items-center px-2">
      <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Senarai Program</h3>
      <button (click)="fetchPrograms()" class="p-2 bg-sky-100 rounded-full text-sky-600 hover:bg-sky-200 hover:rotate-180 transition-all duration-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:rotate-0" [disabled]="isLoading() || (!stateSvc.isCloudConnected() && !stateSvc.isSimulationMode())">
        <svg [class.animate-spin]="isLoading()" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      </button>
    </div>

    @if (isLoading()) {
      <div class="bg-white/50 rounded-[32px] border border-dashed border-sky-200">
        <app-loading-indicator message="Memuat turun senarai program..."></app-loading-indicator>
      </div>
    } @else if (error()) {
      <div class="text-center py-8 bg-red-50/50 rounded-[32px] border border-dashed border-red-200">
        <p class="text-xs text-red-500 italic">{{ error() }}</p>
        <button (click)="fetchPrograms()" class="mt-4 bg-sky-100 text-sky-700 text-xs font-bold px-4 py-2 rounded-lg hover:bg-sky-200 transition-colors">
          Cuba Lagi
        </button>
      </div>
    } @else if (!stateSvc.isCloudConnected() && !stateSvc.isSimulationMode()) {
      <p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">Sila sambung ke Cloud di tab Tetapan untuk memuatkan program.</p>
    } @else if (programs().length === 0) {
      <p class="text-xs text-slate-400 text-center py-8 italic bg-white/50 rounded-[32px] border border-dashed border-sky-200">Tiada program direkodkan.</p>
    } @else {
      <div class="space-y-3">
        @for (prog of programs(); track prog.id || prog.idprogram) {
          @let status = prog.status || 'Belum Mula';
          <div 
            class="bg-white rounded-2xl p-4 border transition-all duration-500 ease-out shadow-sm animate-fade-in-up"
            [style.animation-delay]="$index * 75 + 'ms'"
            [class.border-sky-400]="status === 'Aktif'"
            [class.ring-4]="status === 'Aktif'"
            [class.ring-sky-100]="status === 'Aktif'"
            [class.border-slate-100]="status !== 'Aktif'"
            [class.opacity-60]="status === 'Selesai'"
          >
            <div class="flex justify-between items-start">
              <div class="flex items-center gap-2 flex-wrap">
                <p class="font-bold text-slate-800 pr-2">{{ prog.namaprogram }}</p>
                  <span 
                    class="text-[9px] font-black px-2.5 py-1 rounded-full whitespace-nowrap"
                    [class.bg-emerald-100]="status === 'Selesai'" [class.text-emerald-700]="status === 'Selesai'"
                    [class.bg-sky-100]="status === 'Aktif'" [class.text-sky-700]="status === 'Aktif'"
                    [class.bg-slate-100]="status === 'Belum Mula'" [class.text-slate-700]="status === 'Belum Mula'"
                  >
                    {{ status }}
                  </span>
              </div>
            </div>

            <p class="text-xs font-mono text-sky-700 bg-sky-50 px-2 py-0.5 rounded mt-1 inline-block">{{ prog.id || prog.idprogram }}</p>
            
            <div class="mt-3 pt-3 border-t border-slate-100 grid grid-cols-3 gap-2 text-xs">
                <div>
                    <p class="font-bold text-slate-400">Tarikh</p>
                    <p class="font-semibold text-slate-600">{{ formatDate(prog.tarikh) }}</p>
                </div>
                <div>
                    <p class="font-bold text-slate-400">Masa</p>
                    <p class="font-semibold text-slate-600">{{ formatTime(prog.masa) }}</p>
                </div>
                <div>
                    <p class="font-bold text-slate-400">Lokasi</p>
                    <p class="font-semibold text-slate-600">{{ prog.lokasi }}</p>
                </div>
            </div>
            
            <div class="mt-4 pt-3 border-t border-slate-100 space-y-3">
              <div class="w-full">
                 @if (status === 'Aktif') {
                  <button (click)="setProgramStatus(prog, 'Belum Mula')" [disabled]="lockingProgramId() === prog.id" class="w-full text-sm font-bold bg-slate-500 text-white px-5 py-2.5 rounded-lg hover:bg-slate-600 transition-colors shadow-md shadow-slate-200/50 active:scale-95 disabled:bg-slate-300">
                      Nyahaktifkan
                  </button>
                } @else if (status === 'Belum Mula') {
                  <button (click)="setProgramStatus(prog, 'Aktif')" [disabled]="lockingProgramId() === prog.id" class="w-full text-sm font-bold bg-sky-500 text-white px-5 py-2.5 rounded-lg hover:bg-sky-600 transition-colors shadow-md shadow-sky-200/50 active:scale-95 flex items-center justify-center gap-1.5 disabled:bg-slate-300">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                      <span>Aktifkan</span>
                  </button>
                } @else {
                   <button disabled class="w-full text-sm font-bold bg-emerald-500 text-white px-5 py-2.5 rounded-lg cursor-not-allowed">
                      Program Selesai
                  </button>
                }
              </div>
              <div class="grid grid-cols-3 gap-2">
                <button (click)="openDetailsModal(prog)" class="text-xs font-bold bg-sky-100 text-sky-700 px-3 py-2 rounded-lg hover:bg-sky-200 transition-colors">
                  Maklumat
                </button>
                <button (click)="openEditModal(prog)" [disabled]="stateSvc.isSimulationMode() || status === 'Selesai'" class="text-xs font-bold bg-sky-100 text-sky-700 px-3 py-2 rounded-lg hover:bg-sky-200 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed">
                  Kemaskini
                </button>
                 <button (click)="setProgramStatus(prog, 'Selesai')" [disabled]="lockingProgramId() === prog.id || status === 'Selesai'" class="text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-2 rounded-lg hover:bg-emerald-200 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed">
                  Selesai
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

@if (isDetailsModalVisible(); as program) {
  <app-program-details [program]="program" (close)="closeDetailsModal()"></app-program-details>
}

@if (editingProgram(); as program) {
  <app-program-edit [program]="program" (close)="closeEditModal()" (saved)="handleProgramUpdated($event)"></app-program-edit>
}
