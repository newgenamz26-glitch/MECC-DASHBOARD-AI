<div class="space-y-4">
    <!-- Backend Settings -->
    <div class="bg-white p-6 rounded-[32px] shadow-sm border border-sky-50">
        <div class="flex justify-between items-center">
            <h4 class="font-bold text-sky-800 text-base">Tetapan Backend</h4>
            @if (stateSvc.isCloudConnected()) {
                <span class="text-xs font-black px-2.5 py-1 rounded-full border bg-sky-50 text-sky-600 border-sky-200">DALAM TALIAN</span>
            } @else {
                <span class="text-xs font-black px-2.5 py-1 rounded-full border bg-red-50 text-red-600 border-red-200">LUAR TALIAN</span>
            }
        </div>
        <p class="text-xs text-slate-400 mt-1">Status sambungan ke pangkalan data Cloud.</p>

        <div class="mt-4 space-y-3">
            <button (click)="testConnection()" [disabled]="!stateSvc.gasUrl() || isTesting()" class="w-full bg-sky-600 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-sky-100 active:scale-95 transition-all disabled:bg-slate-300 disabled:shadow-none">
                <div class="flex items-center justify-center gap-2">
                    <svg [class.animate-spin]="isTesting()" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    <span>{{ isTesting() ? 'MENGUJI SAMBUNGAN...' : 'UJI SAMBUNGAN CLOUD' }}</span>
                </div>
            </button>
            <button (click)="toggleBackendSetup()" class="w-full text-center text-sky-700 text-xs font-bold py-2 hover:bg-sky-50 rounded-lg transition-colors">
                 {{ isBackendSetupVisible() ? 'Tutup Tetapan URL' : 'Urus URL Sambungan' }}
            </button>
        </div>

        @if (isBackendSetupVisible()) {
            <div class="mt-4 pt-4 border-t border-slate-100 space-y-3">
                <form [formGroup]="backendForm" (ngSubmit)="verifyCloud()">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">URL Google Script</label>
                        <input type="text" formControlName="url" placeholder="Masukkan URL Script Cloud" class="w-full p-4 mt-1 bg-slate-50 border-0 rounded-2xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none" [readOnly]="stateSvc.isCloudConnected()">
                    </div>
                    @if (!stateSvc.isCloudConnected()) {
                        <button type="submit" [disabled]="isVerifying() || backendForm.invalid" class="w-full bg-sky-600 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-sky-100 active:scale-95 transition-all disabled:bg-slate-300 disabled:shadow-none">
                            {{ isVerifying() ? 'Mengesahkan...' : 'SAHKAN SAMBUNGAN' }}
                        </button>
                    } @else {
                         <button type="button" (click)="resetCloud()" class="w-full bg-slate-600 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-slate-200 active:scale-95 transition-all">
                            RESET SAMBUNGAN
                        </button>
                    }
                </form>
            </div>
        }
    </div>

    <!-- Program Settings -->
    <div class="bg-white p-6 rounded-[32px] shadow-sm border border-sky-50">
        <h4 class="font-bold text-sky-800 text-base">Pengurusan Program</h4>
        <p class="text-xs text-slate-400 mt-1">Tambah atau semak maklumat program di Cloud.</p>
        
        <div class="grid grid-cols-4 gap-3 mt-4">
            <button (click)="toggleProgramForm()" [disabled]="!stateSvc.isCloudConnected()" class="w-full bg-sky-50 text-sky-700 py-3 rounded-xl border border-sky-100 font-bold text-xs hover:bg-sky-100 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1.5 h-20">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                <span>{{ isProgramFormVisible() ? 'Tutup' : 'Baru' }}</span>
            </button>
            <button (click)="checkLatestProgram()" [disabled]="!stateSvc.isCloudConnected() || isCheckingLatestProgram()" class="w-full bg-sky-50 text-sky-700 py-3 rounded-xl border border-sky-100 font-bold text-xs hover:bg-sky-100 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1.5 h-20">
                @if (isCheckingLatestProgram()) {
                    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                }
                <span>Terkini</span>
            </button>
            <button (click)="generateManualProgramId()" [disabled]="!stateSvc.isCloudConnected() || isGeneratingManualId()" class="w-full bg-sky-50 text-sky-700 py-3 rounded-xl border border-sky-100 font-bold text-xs hover:bg-sky-100 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1.5 h-20">
                @if (isGeneratingManualId()) {
                    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                }
                <span>Jana ID</span>
            </button>
            <button (click)="checkNextCloudId()" [disabled]="!stateSvc.isCloudConnected() || isCheckingNextId()" class="w-full bg-sky-50 text-sky-700 py-3 rounded-xl border border-sky-100 font-bold text-xs hover:bg-sky-100 transition-colors disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed flex flex-col items-center justify-center gap-1.5 h-20">
                @if (isCheckingNextId()) {
                    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4.5 16.5A6.5 6.5 0 1 1 17.4 8.1"/><circle cx="15.5" cy="15.5" r="2.5"/><path d="M17.5 17.5 L19.5 19.5"/></svg>
                }
                <span>Semak ID</span>
            </button>
        </div>
        <div class="mt-4">
            <button (click)="openProgramListModal()" [disabled]="!stateSvc.isCloudConnected()" class="w-full text-center text-sky-700 text-sm font-bold py-3 hover:bg-sky-50 rounded-xl transition-colors border border-sky-200 bg-sky-50/50 disabled:bg-slate-100 disabled:text-slate-400">
                Papar Senarai Program Penuh
            </button>
        </div>

        @if (isCheckingNextId() || nextCloudId()) {
            <div class="mt-4 pt-4 border-t border-slate-100">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">ID Cloud Seterusnya</label>
                @if (isCheckingNextId()) {
                    <div class="mt-1">
                        <app-loading-indicator size="small" message="Menyemak ID dari Cloud..."></app-loading-indicator>
                    </div>
                } @else if (nextCloudId()) {
                    <input type="text" [value]="nextCloudId()" readonly class="w-full mt-1 p-3 bg-slate-100 border-0 rounded-xl text-sm font-semibold text-slate-500 focus:ring-0 outline-none cursor-not-allowed">
                }
            </div>
        }

        @if (isGeneratingManualId() || manualGeneratedId()) {
            <div class="mt-4 pt-4 border-t border-slate-100">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Hasil ID Manual</label>
                @if (isGeneratingManualId()) {
                    <div class="mt-1 p-3 bg-slate-100 border-0 rounded-xl text-sm font-semibold text-slate-500 animate-pulse flex items-center" style="height: 46px;">
                        Menjana ID...
                    </div>
                } @else if (manualGeneratedId()) {
                    <input type="text" [value]="manualGeneratedId()" readonly class="w-full mt-1 p-3 bg-slate-100 border-0 rounded-xl text-sm font-semibold text-slate-500 focus:ring-0 outline-none cursor-not-allowed">
                }
            </div>
        }

        @if (!stateSvc.isCloudConnected() && !isProgramFormVisible()) {
             <p class="text-center text-xs text-amber-600 mt-3 bg-amber-50 p-2 rounded-lg border border-amber-100">Sila sambung ke Cloud untuk mengurus program.</p>
        }

        @if (isProgramFormVisible() && stateSvc.isCloudConnected()) {
            <div class="mt-4 pt-4 border-t border-slate-100 space-y-4">
                <form [formGroup]="programForm" (ngSubmit)="saveProgram()">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">ID Program</label>
                        <div class="mt-1">
                            <input type="text" [value]="programId()" readonly class="w-full p-3 bg-slate-100 border-0 rounded-xl text-sm font-semibold text-slate-500 focus:ring-0 outline-none cursor-not-allowed">
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Nama Program</label>
                        <input formControlName="name" type="text" placeholder="Nama Program" class="w-full p-3 mt-1 bg-slate-50 border-0 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none">
                    </div>
                     <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Tarikh</label>
                            <input formControlName="date" type="date" class="w-full p-3 mt-1 bg-slate-50 border-0 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none">
                        </div>
                        <div>
                           <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Masa</label>
                           <input formControlName="time" type="time" class="w-full p-3 mt-1 bg-slate-50 border-0 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none">
                        </div>
                    </div>
                     <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest">Lokasi</label>
                        <input formControlName="location" type="text" placeholder="Lokasi Program" class="w-full p-3 mt-1 bg-slate-50 border-0 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-sky-500 outline-none">
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="submit" [disabled]="programForm.invalid" class="bg-sky-600 text-white text-sm font-black py-3 px-6 rounded-xl disabled:bg-slate-300 active:scale-95 transition-transform shadow-lg shadow-sky-200/50 disabled:shadow-none">
                            SIMPAN KE CLOUD
                        </button>
                    </div>
                </form>
            </div>
        }
    </div>

    <!-- Diagnostics -->
    <div class="bg-white p-6 rounded-[32px] shadow-sm border border-sky-50">
        <h4 class="font-bold text-sky-800 text-base">Diagnostik Sistem</h4>
        <p class="text-xs text-slate-400 mt-1">Sahkan struktur & konfigurasi pangkalan data Cloud anda.</p>
        <div class="mt-4 space-y-3">
            <button (click)="validateSheetStructure()" [disabled]="!stateSvc.isCloudConnected() || isCheckingStructure()" class="w-full bg-amber-500 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-amber-100/50 active:scale-95 transition-all disabled:bg-slate-300 disabled:shadow-none">
                <div class="flex items-center justify-center gap-2">
                    <svg [class.animate-spin]="isCheckingStructure()" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 6.5C15.5 5.26 14.53 4 13.06 4H6.52C5.1 4 4.07 5.26 4.07 6.5V17.5c0 1.24 1.03 2.5 2.45 2.5h8.51c1.42 0 2.47-1.26 2.47-2.5v-3.5"/><path d="m14 10 3-3-3-3"/><path d="M17 7H9"/><path d="m14 14 3-3-3-3"/><path d="M17 11H9"/></svg>
                    <span>{{ isCheckingStructure() ? 'MENYEMAK...' : 'SEMAK STRUKTUR SHEET' }}</span>
                </div>
            </button>
             <button (click)="showConfigInfo()" [disabled]="!stateSvc.isCloudConnected()" class="w-full bg-slate-500 text-white p-4 rounded-2xl font-black text-xs shadow-lg shadow-slate-200/50 active:scale-95 transition-all disabled:bg-slate-300 disabled:shadow-none">
                <div class="flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    <span>PAPAR KONFIGURASI</span>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Full screen modal for program list -->
@if (isProgramListModalVisible()) {
    <div class="fixed inset-0 bg-black/60 z-[9990] flex items-center justify-center p-4" (click)="closeProgramListModal()">
        <div class="bg-sky-50 w-full max-w-lg max-h-[90vh] rounded-3xl shadow-2xl flex flex-col" (click)="$event.stopPropagation()">
            <div class="p-5 border-b border-sky-200 flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-sky-800 text-lg">Senarai Program Direkodkan</h3>
                <button (click)="closeProgramListModal()" class="p-2 bg-sky-100 rounded-full text-sky-600 hover:bg-sky-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-5 overflow-y-auto space-y-3">
                @if (isLoadingPrograms()) {
                    <app-loading-indicator message="Memuat turun data dari Cloud..."></app-loading-indicator>
                } @else if (allPrograms().length === 0) {
                    <p class="text-center text-slate-500 py-10">Tiada program ditemui dalam rekod.</p>
                } @else {
                    @for (prog of allPrograms(); track prog.id) {
                        <div class="bg-white rounded-2xl p-4 border border-slate-100">
                            <p class="font-bold text-slate-800">{{ prog.namaprogram }}</p>
                            <p class="text-xs font-mono text-sky-700 bg-sky-50 px-2 py-0.5 rounded mt-1 inline-block">{{ prog.id }}</p>
                            <div class="mt-3 pt-3 border-t border-slate-100 grid grid-cols-3 gap-2 text-xs">
                                <div>
                                    <p class="font-bold text-slate-400">Tarikh</p>
                                    <p class="font-semibold text-slate-600">{{ prog.tarikh }}</p>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-400">Masa</p>
                                    <p class="font-semibold text-slate-600">{{ prog.masa }}</p>
                                </div>
                                <div>
                                    <p class="font-bold text-slate-400">Lokasi</p>
                                    <p class="font-semibold text-slate-600">{{ prog.lokasi }}</p>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}