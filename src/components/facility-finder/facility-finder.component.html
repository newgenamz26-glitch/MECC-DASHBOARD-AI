<div class="bg-white rounded-[32px] shadow-sm border border-sky-50 overflow-hidden">
  <!-- Header / Toggle Button -->
  <div (click)="toggleExpansion()" class="flex items-center justify-between p-6 cursor-pointer">
    <div class="flex items-center gap-4">
      <div class="bg-teal-100 text-teal-600 p-3 rounded-2xl">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
      </div>
      <div class="flex-grow">
        <h4 class="font-bold text-slate-800">Carian Fasiliti Perubatan</h4>
        <p class="text-xs text-slate-500 mt-1">Cari hospital & klinik terdekat menggunakan AI.</p>
      </div>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 transition-transform duration-300" [class.rotate-180]="isExpanded()">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </div>

  <!-- Collapsible Content -->
  @if(isExpanded()) {
    <div class="p-6 border-t-2 border-dashed border-sky-100 animate-fade-in-up">
      @if (!isGpsConnected()) {
        <div class="text-center py-4">
          <p class="text-sm font-bold text-amber-700">GPS Tidak Aktif</p>
          <p class="text-xs text-slate-500 mt-1">Sila aktifkan GPS dan berikan kebenaran lokasi untuk menggunakan fungsi ini.</p>
        </div>
      } @else if (isLoading()) {
        <app-loading-indicator message="AI sedang memproses lokasi anda..."></app-loading-indicator>
      } @else if (error()) {
        <div class="text-center py-4 bg-red-50/50 rounded-2xl border border-dashed border-red-200">
            <p class="font-bold text-red-700">Gagal Mendapatkan Data</p>
            <p class="text-xs text-red-600 mt-2 px-4">{{ error() }}</p>
            <button (click)="findFacilities()" class="mt-4 bg-sky-100 text-sky-700 text-xs font-bold px-4 py-2 rounded-lg hover:bg-sky-200 transition-colors">
                Cuba Semula
            </button>
        </div>
      } @else if (facilities().length === 0 && hasFetchedOnce()) {
         <div class="text-center py-4 bg-white/50 rounded-2xl border border-dashed border-sky-200">
            <p class="text-sm font-bold text-slate-600">Tiada Fasiliti Ditemui</p>
            <p class="text-xs text-slate-400 mt-1">AI tidak dapat mencari fasiliti perubatan berdekatan.</p>
        </div>
      } @else {
         <div class="space-y-6">
            <div class="flex justify-end">
                <button (click)="findFacilities()" class="flex items-center gap-1.5 text-xs font-bold text-sky-600 bg-sky-100 px-3 py-1.5 rounded-lg hover:bg-sky-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    <span>Segar Semula</span>
                </button>
            </div>
            <!-- Hospitals -->
            @if (hospitals().length > 0) {
                <div class="space-y-3">
                    <h4 class="text-xs font-black text-red-600 uppercase tracking-widest">Hospital</h4>
                    @for (hospital of hospitals(); track hospital.nama) {
                        <div class="bg-sky-50/50 p-4 rounded-xl border border-slate-200 flex justify-between items-center gap-3">
                            <div class="flex-grow">
                                <p class="font-bold text-slate-800">{{ hospital.nama }}</p>
                                <div class="flex items-center gap-3 text-sm font-semibold text-slate-500 mt-1">
                                    <span>{{ hospital.jarak }}</span>
                                    @if(hospital.status) {
                                      <div class="flex items-center gap-1.5">
                                        <div class="w-2 h-2 rounded-full" [class]="getStatusColor(hospital.status)"></div>
                                        <span class="text-xs">{{ hospital.status }}</span>
                                      </div>
                                    }
                                </div>
                            </div>
                            <button (click)="openInMaps(hospital)" class="flex-shrink-0 bg-sky-100 text-sky-700 px-3 py-2 rounded-lg hover:bg-sky-200 transition-colors text-xs font-bold flex items-center gap-2" title="Buka di Peta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg>
                                <span>Peta</span>
                            </button>
                        </div>
                    }
                </div>
            }
            <!-- Clinics -->
             @if (clinics().length > 0) {
                <div class="space-y-3">
                    <h4 class="text-xs font-black text-blue-600 uppercase tracking-widest">Klinik</h4>
                    @for (clinic of clinics(); track clinic.nama) {
                        <div class="bg-sky-50/50 p-4 rounded-xl border border-slate-200 flex justify-between items-center gap-3">
                            <div class="flex-grow">
                                <p class="font-bold text-slate-800">{{ clinic.nama }}</p>
                                <div class="flex items-center gap-3 text-sm font-semibold text-slate-500 mt-1">
                                    <span>{{ clinic.jarak }}</span>
                                    @if(clinic.status) {
                                      <div class="flex items-center gap-1.5">
                                        <div class="w-2 h-2 rounded-full" [class]="getStatusColor(clinic.status)"></div>
                                        <span class="text-xs">{{ clinic.status }}</span>
                                      </div>
                                    }
                                </div>
                            </div>
                            <button (click)="openInMaps(clinic)" class="flex-shrink-0 bg-sky-100 text-sky-700 px-3 py-2 rounded-lg hover:bg-sky-200 transition-colors text-xs font-bold flex items-center gap-2" title="Buka di Peta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg>
                                <span>Peta</span>
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
      }
    </div>
  }
</div>